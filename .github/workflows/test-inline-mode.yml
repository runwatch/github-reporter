name: Test Inline Mode

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop

permissions:
  actions: read
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate random duration
        id: duration
        run: |
          # Generate random duration between 5-30 seconds
          DURATION=$(( (RANDOM % 26) + 5 ))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "Will run for $DURATION seconds"
      
      - name: Simulate setup work
        run: |
          sleep ${{ steps.duration.outputs.duration }}
          echo "Setup completed"
      
      - name: Random failure chance
        run: |
          FAIL_CHANCE=$(( RANDOM % 100 ))
          echo "Random value: $FAIL_CHANCE"
          if [ $FAIL_CHANCE -lt 10 ]; then
            echo "Random failure triggered (10% chance)"
            exit 1
          fi
          echo "Setup succeeded"

  build:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Calculate random duration
        id: duration
        run: |
          # Generate random duration between 5-30 seconds
          DURATION=$(( (RANDOM % 26) + 5 ))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "Will run for $DURATION seconds"
      
      - name: Simulate build work
        run: |
          sleep ${{ steps.duration.outputs.duration }}
          echo "Build completed"
      
      - name: Random failure chance
        run: |
          FAIL_CHANCE=$(( RANDOM % 100 ))
          echo "Random value: $FAIL_CHANCE"
          if [ $FAIL_CHANCE -lt 10 ]; then
            echo "Random failure triggered (10% chance)"
            exit 1
          fi
          echo "Build succeeded"

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Calculate random duration
        id: duration
        run: |
          # Generate random duration between 5-30 seconds
          DURATION=$(( (RANDOM % 26) + 5 ))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "Will run for $DURATION seconds"
      
      - name: Simulate test work
        run: |
          sleep ${{ steps.duration.outputs.duration }}
          echo "Tests completed"
      
      - name: Random failure chance
        run: |
          FAIL_CHANCE=$(( RANDOM % 100 ))
          echo "Random value: $FAIL_CHANCE"
          if [ $FAIL_CHANCE -lt 10 ]; then
            echo "Random failure triggered (10% chance)"
            exit 1
          fi
          echo "Tests passed"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Calculate random duration
        id: duration
        run: |
          # Generate random duration between 5-30 seconds
          DURATION=$(( (RANDOM % 26) + 5 ))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "Will run for $DURATION seconds"
      
      - name: Simulate deploy work
        run: |
          sleep ${{ steps.duration.outputs.duration }}
          echo "Deploy completed"
      
      - name: Random failure chance
        run: |
          FAIL_CHANCE=$(( RANDOM % 100 ))
          echo "Random value: $FAIL_CHANCE"
          if [ $FAIL_CHANCE -lt 10 ]; then
            echo "Random failure triggered (10% chance)"
            exit 1
          fi
          echo "Deploy succeeded"

  report:
    runs-on: ubuntu-latest
    needs: [setup, build, test, deploy]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Report metrics (dry run)
        uses: ./
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          runwatch_api_key: ${{ secrets.RUNWATCH_API_KEY }}
          runwatch_api_url: ${{ secrets.RUNWATCH_API_URL }}
          debug: ${{ vars.DEBUG || 'true' }}
          dry_run: ${{ vars.DRY_RUN || 'true' }}
